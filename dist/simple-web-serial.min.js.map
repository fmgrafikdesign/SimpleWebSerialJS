{"version":3,"file":"simple-web-serial.min.js","sources":["webpack://SimpleWebSerial/./src/SimpleWebSerial.ts"],"sourcesContent":["/** Default baudrate (57600) for serial communication. Common for many Arduino boards. */\r\nexport const DEFAULT_BAUDRATE = 57600;\r\n\r\nexport interface ConnectionConfiguration {\r\n    baudRate: number;\r\n    requestElement: HTMLElement | string | null;\r\n    requestAccessOnPageLoad: boolean;\r\n    accessText: string;\r\n    accessButtonLabel: string;\r\n    styleDomElements: boolean;\r\n    transformer: Transformer<string, string>;\r\n    logIncomingSerialData: boolean;\r\n    logOutgoingSerialData: boolean;\r\n    parseStringsAsNumbers: boolean;\r\n    warnAboutUnregisteredEvents: boolean;\r\n    newLineCharacter: string;\r\n    filters: SerialPortFilter[];\r\n}\r\n\r\nexport type JsonValue =\r\n    | string\r\n    | number\r\n    | boolean\r\n    | null\r\n    | JsonObject\r\n    | JsonArray;\r\n\r\nexport interface JsonObject {\r\n    [key: string]: JsonValue;\r\n}\r\n\r\nexport type JsonArray = Array<JsonValue>;\r\n\r\nexport type ListenerCallback = (data: JsonValue) => void;\r\nexport type Listener = [string, ListenerCallback];\r\nexport type Listeners = Record<string, ListenerCallback[]>;\r\n\r\nexport class LineBreakTransformer implements Transformer<string, string> {\r\n    private chunks: string;\r\n    private delimiter: string;\r\n\r\n    constructor(delimiter: string = '\\r\\n') {\r\n        this.chunks = '';\r\n        this.delimiter = delimiter;\r\n    }\r\n\r\n    transform(chunk: string, controller: TransformStreamDefaultController<string>): void {\r\n        try {\r\n            this.chunks += chunk;\r\n            const lines = this.chunks.split(this.delimiter);\r\n            this.chunks = lines.pop() || '';\r\n            for (const line of lines) {\r\n                controller.enqueue(line);\r\n            }\r\n        } catch (error) {\r\n            console.error(`Transformation Error: ${error} @chunk: ${chunk}`);\r\n        }\r\n    }\r\n\r\n    flush(controller: TransformStreamDefaultController<string>): void {\r\n        try {\r\n            if (this.chunks) {\r\n                controller.enqueue(this.chunks);\r\n            }\r\n        } catch (error) {\r\n            console.error(`Flushing Error: ${error}`);\r\n        }\r\n    }\r\n}\r\n\r\n// Function to parse values as numbers if possible\r\nexport function parseNumbersRecursively(value: JsonValue): JsonValue {\r\n    if (typeof value === 'number') return value;\r\n    if (typeof value === 'string' && !Number.isNaN(+value) && value.trim() !== '') return parseFloat(value);\r\n    if (Array.isArray(value)) return value.map(item => parseNumbersRecursively(item));\r\n    if (typeof value === 'object' && value !== null) {\r\n        const result: { [key: string]: JsonValue } = {};\r\n        for (const key in value) {\r\n            result[key] = parseNumbersRecursively(value[key]);\r\n        }\r\n        return result;\r\n    }\r\n    return value;\r\n}\r\n\r\n// Factory function to create the default configuration object\r\nexport function createDefaultConstructorObject(): ConnectionConfiguration {\r\n    return {\r\n        baudRate: DEFAULT_BAUDRATE,\r\n        requestElement: null,\r\n        requestAccessOnPageLoad: false,\r\n        accessText:\r\n            'To access serial devices, user interaction is required. Please press this button to select the serial device you want to connect to.',\r\n        accessButtonLabel: 'Choose device / port',\r\n        styleDomElements: true,\r\n        transformer: new LineBreakTransformer(),\r\n        logIncomingSerialData: false,\r\n        logOutgoingSerialData: false,\r\n        parseStringsAsNumbers: true,\r\n        warnAboutUnregisteredEvents: true,\r\n        newLineCharacter: '\\n',\r\n        filters: [],\r\n    };\r\n}\r\n\r\n// Class representing the serial connection\r\nexport class SerialConnection {\r\n    private port: SerialPort | null = null;\r\n    private writer: WritableStreamDefaultWriter<string> | null = null;\r\n    private _modalElement: HTMLElement | null = null;\r\n    private _modalErrorElement: HTMLElement | null = null;\r\n    private _listeners: Listeners = {};\r\n    public configuration: ConnectionConfiguration;\r\n\r\n    constructor(configuration: ConnectionConfiguration) {\r\n        this.configuration = configuration;\r\n        this.startConnection = this.startConnection.bind(this);\r\n        this.createModal = this.createModal.bind(this);\r\n    }\r\n\r\n    public requestSerialAccessOnClick(element: string | HTMLElement): void {\r\n        if (typeof element === 'string') {\r\n            const el = document.getElementById(element);\r\n            if (!el) throw new Error(`Could not find element with ID '${element}'.`);\r\n            element = el;\r\n        }\r\n        element.addEventListener('click', this.startConnection);\r\n    }\r\n\r\n    public createModal(): void {\r\n        const [\r\n            modal,\r\n            modalOverlay,\r\n            modalContainer,\r\n            modalInner,\r\n            modalInnerText,\r\n            modalErrorText,\r\n            modalInnerButton,\r\n        ] = ['div', 'div', 'div', 'div', 'p', 'p', 'button'].map(tag => document.createElement(tag));\r\n\r\n        modalContainer.classList.add('SimpleWebSerial-modal-container');\r\n        modalOverlay.classList.add('SimpleWebSerial-modal-overlay');\r\n        modalInner.classList.add('SimpleWebSerial-modal-inner');\r\n\r\n        if (this.configuration.styleDomElements) {\r\n            modal.setAttribute(\r\n                'style',\r\n                'position: fixed; left: 0; top: 0; width: 100%; height: 100%; z-index: 10000',\r\n            );\r\n            modalOverlay.setAttribute(\r\n                'style',\r\n                'background-color: rgba(0,0,0,.3); position: absolute; left: 0; top: 0; width: 100%; height: 100%; cursor: pointer',\r\n            );\r\n            modalContainer.setAttribute(\r\n                'style',\r\n                'position: absolute; width: 100%; height: auto; padding: 4rem; box-sizing: border-box;',\r\n            );\r\n            modalInner.setAttribute(\r\n                'style',\r\n                'background-color: #fff; border-radius: 4px; padding: 1rem; box-shadow: 0px 2px 11px 4px rgba(0,0,0, .09);',\r\n            );\r\n            modalInnerText.setAttribute('style', 'color: #000');\r\n            modalErrorText.setAttribute('style', 'color: #dd0000');\r\n        }\r\n\r\n        modalInnerText.innerText = this.configuration.accessText;\r\n        modalInnerButton.innerText = this.configuration.accessButtonLabel;\r\n        this.requestSerialAccessOnClick(modalInnerButton);\r\n        modalInner.append(modalInnerText, modalErrorText, modalInnerButton);\r\n        modalContainer.append(modalInner);\r\n        modal.append(modalOverlay, modalContainer);\r\n\r\n        this._modalElement = modal;\r\n        this._modalErrorElement = modalErrorText;\r\n        document.body.append(modal);\r\n    }\r\n\r\n    private showErrorMessageInModal(message: string): void {\r\n        if (!this._modalErrorElement) return;\r\n        this._modalErrorElement.innerHTML = message;\r\n    }\r\n\r\n    private removeModal(): void {\r\n        this._modalElement?.remove();\r\n    }\r\n\r\n    public async startConnection(): Promise<void> {\r\n        if (this.ready()) throw new Error('Serial connection has already been established.');\r\n        try {\r\n            this.port = await navigator.serial.requestPort({ filters: this.configuration.filters });\r\n            await this.port.open({ baudRate: this.configuration.baudRate });\r\n        } catch (e) {\r\n            this.showErrorMessageInModal(\r\n                'There was an error trying to open a serial connection. ' +\r\n                'Please make sure the port is not occupied in another tab or process. Error message:<br>' +\r\n                e,\r\n            );\r\n            throw e;\r\n        }\r\n        if (this.configuration.requestAccessOnPageLoad) {\r\n            this.removeModal();\r\n        }\r\n        const textEncoder = new TextEncoderStream();\r\n        this.writer = textEncoder.writable.getWriter();\r\n\r\n        const decoder = new TextDecoderStream();\r\n\r\n        // Piping the streams\r\n        textEncoder.readable.pipeTo(this.port.writable!);\r\n        this.port.readable!.pipeTo(decoder.writable);\r\n\r\n        const inputStream = decoder.readable;\r\n        const reader = inputStream\r\n            .pipeThrough(new TransformStream(this.configuration.transformer))\r\n            .getReader();\r\n        this.readLoop(reader).catch(e => {\r\n            console.error(\r\n                'Could not read serial data. Please make sure the same baud rate is used on device (Serial.begin()) and library. Library currently uses baud rate',\r\n                this.configuration.baudRate,\r\n                \"Please also make sure you're not sending too much serial data. Consider using (a higher) delay() to throttle the amount of data sent.\",\r\n            );\r\n            console.error(e);\r\n        });\r\n    }\r\n\r\n    public on(name: string, callback: ListenerCallback): Listener {\r\n        if (!this._listeners[name]) {\r\n            this._listeners[name] = [];\r\n        }\r\n        this._listeners[name].push(callback);\r\n        return [name, callback];\r\n    }\r\n\r\n    public removeListener(nameOrListener: string | Listener, callbackToRemove?: ListenerCallback): boolean {\r\n        let name: string;\r\n        if (Array.isArray(nameOrListener) && callbackToRemove === undefined) {\r\n            [name, callbackToRemove] = nameOrListener;\r\n        } else if (typeof nameOrListener === 'string' && callbackToRemove !== undefined) {\r\n            name = nameOrListener;\r\n        } else {\r\n            throw new Error('Invalid arguments for removeListener.');\r\n        }\r\n\r\n        if (!this._listeners[name]) {\r\n            throw new Error('There is no listener named ' + name + '.');\r\n        }\r\n        const length = this._listeners[name].length;\r\n        this._listeners[name] = this._listeners[name].filter(listener => listener !== callbackToRemove);\r\n        return length !== this._listeners[name].length;\r\n    }\r\n\r\n    public removeListeners(name: string): boolean {\r\n        if (typeof name !== 'string') {\r\n            throw new Error(\r\n                'removeListeners expects a string as parameter, which will be used to remove all listeners of that event.',\r\n            );\r\n        }\r\n        const length = this._listeners[name]?.length || 0;\r\n        this._listeners[name] = [];\r\n        return length > 0;\r\n    }\r\n\r\n    public ready(): boolean {\r\n        return !!(this.port?.readable && this.port?.writable);\r\n    }\r\n\r\n    public readable(): ReadableStream<Uint8Array> | null {\r\n        return this.port?.readable || null;\r\n    }\r\n\r\n    public writable(): WritableStream<Uint8Array> | null {\r\n        return this.port?.writable || null;\r\n    }\r\n\r\n    public async send(name: string, data?: JsonValue): Promise<void> {\r\n        if (!this.port?.writable || !this.writer) return;\r\n        let messageToSend;\r\n\r\n        if (data === undefined) {\r\n            if (this.configuration.logOutgoingSerialData) {\r\n                console.log(name);\r\n            }\r\n            if (this.configuration.parseStringsAsNumbers) {\r\n                name = parseNumbersRecursively(name) as string;\r\n            }\r\n            messageToSend = ['_d', name];\r\n        } else {\r\n            if (this.configuration.parseStringsAsNumbers) {\r\n                data = parseNumbersRecursively(data);\r\n            }\r\n            messageToSend = [name, data];\r\n        }\r\n\r\n        const stringified = JSON.stringify(messageToSend);\r\n        if (this.configuration.logOutgoingSerialData) {\r\n            console.log(stringified);\r\n        }\r\n\r\n        await this.writer.write(stringified + this.configuration.newLineCharacter);\r\n    }\r\n\r\n    public async sendEvent(name: string): Promise<void> {\r\n        await this.send('_e', name);\r\n    }\r\n\r\n    public async sendData(data: JsonValue): Promise<void> {\r\n        await this.send('_d', data);\r\n    }\r\n\r\n    public emit(name: string, data: JsonValue): void {\r\n        if (this._listeners[name]) {\r\n            this._listeners[name].forEach(callback => callback(data));\r\n        } else if (this.configuration.warnAboutUnregisteredEvents) {\r\n            console.warn('Event ' + name + ' has been received, but it has never been registered as listener.');\r\n        }\r\n    }\r\n\r\n    private async readLoop(reader: ReadableStreamDefaultReader<string>): Promise<void> {\r\n        while (true) {\r\n            const { value, done } = await reader.read();\r\n            if (value) {\r\n                let json: JsonValue = null;\r\n                try {\r\n                    json = JSON.parse(value);\r\n                } catch (error) {\r\n                    if (this.configuration.logIncomingSerialData) {\r\n                        console.warn('Failed to parse serial data:', value, '| Reported error:', error);\r\n                    }\r\n                }\r\n                if (json) {\r\n                    if (this.configuration.logIncomingSerialData) {\r\n                        console.log(json);\r\n                    }\r\n                    // Handling special events\r\n                    if (Array.isArray(json)) {\r\n                        switch (json[0]) {\r\n                            case '_w':\r\n                                console.warn('[ARDUINO] ' + json[1]);\r\n                                continue;\r\n                            case '_l':\r\n                                console.log('[ARDUINO] ' + json[1]);\r\n                                continue;\r\n                            case '_e':\r\n                                console.error('[ARDUINO] ' + json[1]);\r\n                                continue;\r\n                            case '_d':\r\n                                this.emit('data', json[1]);\r\n                                continue;\r\n                            default:\r\n                                this.emit(json[0] as string, json[1]);\r\n                                continue;\r\n                        }\r\n                    } else if (typeof json === 'string') {\r\n                        this.emit(json, null);\r\n                    }\r\n                } else {\r\n                    if (this.configuration.logIncomingSerialData) {\r\n                        console.log(value);\r\n                    }\r\n                }\r\n            }\r\n            if (done) {\r\n                console.log('[readLoop] DONE', done);\r\n                reader.releaseLock();\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    public getPort(): SerialPort | null {\r\n        return this.port;\r\n    }\r\n\r\n    public getWriter(): WritableStreamDefaultWriter<string> | null {\r\n        return this.writer;\r\n    }\r\n\r\n    public setWriter(newWriter: WritableStreamDefaultWriter<string>): WritableStreamDefaultWriter<string> {\r\n        this.writer = newWriter;\r\n        return this.writer;\r\n    }\r\n\r\n    public get modalElement(): HTMLElement | null {\r\n        return this._modalElement;\r\n    }\r\n}\r\n\r\n// Function to set up the serial connection\r\nexport function setupSerialConnection(\r\n    args?: number | Partial<ConnectionConfiguration>,\r\n): SerialConnection {\r\n    if (!navigator.serial) {\r\n        throw new Error(\r\n            \"The Serial API is not supported in your browser. Make sure you've enabled flags if necessary!\",\r\n        );\r\n    }\r\n\r\n    let configuration: ConnectionConfiguration;\r\n    if (typeof args === 'number') {\r\n        configuration = { ...createDefaultConstructorObject(), baudRate: args };\r\n    } else if (typeof args === 'undefined') {\r\n        configuration = createDefaultConstructorObject();\r\n    } else if (typeof args === 'object') {\r\n        configuration = { ...createDefaultConstructorObject(), ...args };\r\n    } else {\r\n        throw new Error('Invalid arguments for setupSerialConnection.');\r\n    }\r\n\r\n    if (configuration.requestElement != null) {\r\n        configuration = { ...configuration, requestAccessOnPageLoad: false };\r\n    }\r\n\r\n    const instance = new SerialConnection(configuration);\r\n\r\n    // If a button or an ID was supplied, attach an event listener to it.\r\n    if (configuration.requestElement) {\r\n        instance.requestSerialAccessOnClick(configuration.requestElement);\r\n    }\r\n\r\n    // If the library should handle requesting access to the serial device, create a modal on page load.\r\n    if (configuration.requestAccessOnPageLoad) {\r\n        window.addEventListener('load', instance.createModal);\r\n    }\r\n\r\n    return instance;\r\n}"],"names":["DEFAULT_BAUDRATE","LineBreakTransformer","chunk","controller","lines","line","error","console","delimiter","parseNumbersRecursively","value","Number","parseFloat","Array","item","result","key","createDefaultConstructorObject","SerialConnection","element","el","document","Error","modal","modalOverlay","modalContainer","modalInner","modalInnerText","modalErrorText","modalInnerButton","tag","message","_this__modalElement","navigator","e","textEncoder","TextEncoderStream","decoder","TextDecoderStream","reader","inputStream","TransformStream","name","callback","nameOrListener","callbackToRemove","undefined","length","listener","_this__listeners_name","_this_port","_this_port1","data","messageToSend","stringified","JSON","done","json","newWriter","configuration","setupSerialConnection","args","instance","window"],"mappings":"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"}